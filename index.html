<!DOCTYPE html>
<html>
    <head>
        <title>Hotkey Grid</title>
        <script>
          window.cl = console.log.bind(console);
          $ = window.$ = window.jQuery = require('jquery');
          require('jquery-ui');
          require('bootstrap');
          var ko = require('knockout');
          require('knockout-mapping');
          require('knockout-sortable');
          // var keys = require('clays-keys');

          // file system node stuff
          var sys = require('sys');
          function puts(error, stdout, stderr) { sys.puts(stdout) }
          var exec = require('child_process').exec;
          var fs = require('fs');

          // for opening files
          var remote = require('remote'); 
          var dialog = remote.require('dialog'); 
          //http://www.mylifeforthecode.com/getting-started-with-standard-dialogs-in-electron/
        </script>
         <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.css">
         <link rel="stylesheet" href="./node_modules/jquery-ui/themes/smoothness/jquery-ui.css">
    </head>
    <body class='fluid-container' style="margin:15px;">
    <style>
      .btn-key {
          margin: 4px;
          width:95%;
          height: 95%;
      }
      .key-text {
          position: relative;
          top: 50%;
          transform: translateY(-50%);
      }
      .keySpace {
          border: black 1px dashed;
          margin: 0;
          float: left;
          padding: 0;
          height:120px;
      }
      .looseKeyBox {
          list-style-type: none;
          padding: 5px;
          border: black 1px solid;
          z-index:0;
          height:200px;
      }
      #numberedTabs.nav-tabs .active a {
          background-color:#337ab7;
          color:#fff;
      }
      .full-width {
          width: 100%;
      }
    </style>
<div classs="" role="tabpanel">
    <ul class="nav nav-tabs" id='numberedTabs' role="tablist" data-bind="sortable: config.tabs">
        <li role="presentation" data-bind="css: { active: $root.selectedTab() === $data }">
            <a href="#" role="tab" data-toggle="tab" 
            data-bind="text: tabName() + ' (' + ($index() + 1) + ')',
                       attr: { href: '#' + tabName() },
                       click: $root.selectTab
                       "></a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content" data-bind="sortable: config.tabs">
        <div role="tabpanel" class="tab-pane" data-bind="attr: {id: tabName}, css: { active: $root.selectedTab() === $data }">
            <div class="" data-bind="foreach: rows">
                <div class="" data-bind="foreach: cols">
                    <div class="col-xs-2 keySpace" data-bind="sortable: { data: keys, allowDrop : $root.isFull }">
                        <div class="btn btn-primary btn-key"
                            data-bind="click: $root.selectedKey,
                            css : typeof $root.selectedKey() === 'undefined' || $root.selectedKey() !== $data ? 'btn-primary' : 'btn-danger'">
                            <div class="key-text" data-bind="html: $root.keyHtml($data) + '<br>(' + $parent.key() + ')'"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<br>
<div class="row">
    <div class="col-xs-2">
        <button class="btn btn-success full-width" data-bind='click: $root.switchEditMode,
                       html: $root.editmode() ? "Use Mode" : "Edit Mode"'></button>
    </div>
    <div class="col-xs-5" data-bind="visible: $root.editmode()">
        <div data-bind="with: selectedKey">
          <div class="row">
              <div class="col-xs-3">Name</div><div class="col-xs-9"><input id='keyNameInput' data-bind="value:keyName, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Icon</div><div class="col-xs-9"><input data-bind="value:icon, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Executor</div><div class="col-xs-9"><input data-bind="value:executor, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Script</div>
              <div class="col-xs-6">
                <button class='btn btn-sm btn-warning full-width' data-bind="click: $root.getFilePath, text: $root.getFileName(script()), attr : { title: script }"></button>
                <!-- <input data-bind="value:script, valueUpdate:'afterkeydown'"/> -->
                <!-- <input id="asdf" type='file' data-bind="value:script"/> -->
              </div>
              <div class="col-xs-3"><button class='btn btn-sm btn-success full-width' data-bind="enable:script, click: $root.editScript ">Edit</button></div>
          </div>
          <div class="row">
              <!-- <button class="btn btn-success col-xs-6" data-bind='click: $root.unfocusKey'>Done</button> -->
              <button class="btn btn-danger col-xs-12" data-bind='click: $root.deleteKey'>Delete</button>
          </div>
        </div>
    </div>
    <div class="col-xs-5" data-bind="visible: $root.editmode()">
        <div class="looseKeyBox" data-bind="sortable: config.looseKeys">
            <div class="btn btn-primary" 
            data-bind=" html: $root.keyHtml($data),
                        click: $root.selectedKey,
                        css : typeof $root.selectedKey() === 'undefined' || $root.selectedKey() !== $data ? 'btn-primary' : 'btn-danger'"></div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <h4>Loose Keys</h4>
            </div>
            <div class="col-xs-6">
                <button class="btn btn-primary full-width" data-bind="click : $root.addKey">Add</button>
            </div>
        </div>
    </div>
</div>
<div class="row" data-bind="visible: $root.editmode()">
    <div class="col-xs-2">
        <button class="btn btn-success full-width" data-bind="click : $root.addTab">Add Tab</button>
    </div>
    <div class="col-xs-5">
        <div data-bind="with: selectedTab">
          <div class="row">
              <div class="col-xs-3">Tab Name</div>
              <div class="col-xs-6">
                <input id='tabNameInput' data-bind="value:tabName, valueUpdate:'afterkeydown'"/>`
              </div>
              <button class="btn btn-danger col-xs-3" data-bind="click : $root.deleteTab">Delete</button>
          </div>
        </div>
    </div>
</div>
<div class="row" data-bind="visible: $root.editmode()">
  <div class="col-xs-3">
    Default Executor
  </div>
  <div class="col-xs-3">
    <input id='tabNameInput' data-bind="value:config.defaultExecutor, valueUpdate:'afterkeydown'"/>`
  </div>
  <div class="col-xs-3">
    Default Script Editor
  </div>
  <div class="col-xs-3">
    <input id='tabNameInput' data-bind="value:config.defaultScriptEditor, valueUpdate:'afterkeydown'"/>`
  </div>
</div>
<div class="row">
  <div class="col-xs-3">
    Command Output
  </div>
  <div class="col-xs-9" data-bind="text: $root.commandOutput">
  </div>
</div>
<script>
// active class on li and div see - http://getbootstrap.com/javascript/#tabs

var keyboard = [
    ['q', 'w', 'e', 'r', 't', 'y'],
    ['a', 's', 'd', 'f', 'g', 'h'],
    ['z', 'x', 'c', 'v', 'b', 'n']
];
var MAX_TABS = 6;
var DEFAULT_CONFIG_FILE_NAME = './default-config.hkg';
var MY_CONFIG_FILE_NAME = './my-config.hkg';
var CONFIG_FILE_NAME = './config.hkg';

function fillInMissingKeysOnTab(tab) {
    for (var r = 0; r < 3; r++) {
        if (typeof tab.rows[r] === 'undefined') {
            tab.rows[r] = {cols:[]};
        }
        var row = tab.rows[r];
        for (var k = 0; k < 6; k++) {
            if (typeof row.cols[k] === 'undefined') {
                row.cols[k] = {key: keyboard[r][k], keys:[]};
            } else {
                row.cols[k].key = keyboard[r][k];
            }
        }
    }
    return tab;
}

function HostsViewModel(config) {
    var vm = this;
    this.config = ko.mapping.fromJS(config);

    // add computed fields to Keys
    this.keyHtml = function(key) {
        var icon = key.icon();
        if (icon) {
            return '<img class="img-responsive" src="'+icon+'"></img>';
        } else {
            return key.keyName();
        }
    };
    // edit v. use mode
    this.editmode = ko.observable(true);
    this.switchEditMode = function() {
      //$root.editmode(!$root.editmode())
      vm.editmode(!vm.editmode());
    };
    // file path
    this.getFilePath = function (key) {
      var cwd = process.cwd();
      var posix = cwd.indexOf('/') !== -1;
      cwd += posix ? '/' : '\\';
      var newPath = dialog.showOpenDialog({ defaultPath: cwd + key.script(), properties: [ 'openFile']});
      var newRelativePath = (typeof newPath === 'undefined') ? '' : newPath[0].replace(cwd, '');
      key.script(newRelativePath);
    };
    this.getFileName = function(path) {
      // var path = key.script();
      if (path === '') return '(Click to set a script)';
      var segs = path.split('/');
      if (segs.length > 1) {
        return segs.pop();
      } else {
        return path.split('\\').pop();
      }
    };
    // edit script
    this.editScript = function(key) {
      debugger;
      var command = vm.config.defaultScriptEditor() + ' ' + key.script();
      exec(command, function(e, stdout, stderr) {
                        if (stderr) { alert(stderr); }
                        vm.commandOutput(stdout);
                      });
    };
    // tab stuff
    this.selectedTab = ko.observable();
    this.selectTab = function(t) {
        if (vm.selectedTab !== t) vm.selectedKey(undefined);
        vm.selectedTab(t);
    };
    this.selectedTab(this.config.tabs()[0]);
    this.addTab = function() {
        if (vm.config.tabs().length === MAX_TABS) return;
        var tab = ko.mapping.fromJS(fillInMissingKeysOnTab({ tabName : 'New Tab', rows : [] }));
        vm.config.tabs.push(tab);
        vm.selectTab(tab);
        setTimeout(function() {   $('#tabNameInput').focus().select();   });
    };
    this.deleteTab = function() {
        var selectedTab = vm.selectedTab();
        var tabs = vm.config.tabs();
        if (tabs.length === 1) { alert('You cannot delete your only tab.'); return }
        for (var t = 0; t < tabs.length; t++) {
            if (tabs[t] == selectedTab) {
                vm.config.tabs.splice(t,1);
                if (t === 0) {
                    vm.selectTab(tabs[0]);
                } else {
                    vm.selectTab(tabs[t-1]);
                }
                return;
            }
        }
    };
    // key stuff
    this.isFull = function(parent) {
        return parent().length < 1;
    };
    this.selectedKey = ko.observable();
    this.verifyMove = function(arg, event, ui ) {
        // prevent swapping tabs and keys
        var targetParent = arg.targetParent();
        if (typeof arg.item.keyName !== 'undefined' // is key
             && targetParent[0] && typeof targetParent[0].tabName !== 'undefined') { // is tab
            arg.cancelDrop = true; return
        }
        var $sender = $(arg.sourceParentNode);
        var $target = $(event.target);
        if ($sender.attr('id') === 'numberedTabs' && $target.attr('id') !== 'numberedTabs' ||
            $target.attr('id') === 'numberedTabs' && $sender.attr('id') !== 'numberedTabs') {
            arg.cancelDrop = true; return
        }
        // prevent person from moving off this tab directly by going to the top right corner
        var targetId = $(event.target).parents().filter('.tab-pane').attr('id');
        var senderId = $(ui.sender).parents().filter('.tab-pane').attr('id');
        if (typeof targetId === 'string' && typeof senderId === 'string' && targetId != senderId) arg.cancelDrop = true;
    };
    // this.unfocusKey = function() { vm.selectedKey(undefined); };
    this.deleteKey = function() {
        var key = vm.selectedKey();
        var tabs = vm.config.tabs();
        for (var t = 0; t < tabs.length; t++) {
            var rows = tabs[t].rows();
            for (var r = 0; r < 3; r++) {
                var cols = rows[r].cols();
                for (var k = 0; k < 6; k++) {
                    if (cols[k].keys()[0] === key) {
                        cols[k].keys.pop();
                        break;
                    }
                }
            }
        }
        var looseKeys = vm.config.looseKeys();
        for (var k = 0; k < looseKeys.length; k++) {
            if (looseKeys[k] === key) {
                vm.config.looseKeys.splice(k,1);
                break;
            }
        }
        vm.selectedKey(undefined);
    };
    this.addKey = function() {
        var key = ko.mapping.fromJS({
            keyName : 'New Key',
            icon : '',
            executor : vm.config.defaultExecutor,
            script : ''
        });
        vm.config.looseKeys.push(key);
        vm.selectedKey(key);
        setTimeout(function() {
            $('#keyNameInput').focus().select();
        });
    };

    // make keydown's activate tabs and keys
    $(document).on('keydown', function() {
        if (document.activeElement.tagName === 'INPUT') return true;
        var keyStr = String.fromCharCode(event.which);
        if (!isNaN(keyStr)) {
            var index = parseInt(keyStr, 10) - 1;
            var tabs = vm.config.tabs();
            if (index === -1) {
                vm.selectTab(vm.config.tabs()[0]);
            } else if (tabs.length > index) {
                vm.selectTab(vm.config.tabs()[index]);
            } else if (tabs.length < MAX_TABS) {
                vm.addTab();
            }
        } else {
            var selectedTab = vm.selectedTab();
            if (typeof selectedTab === 'undefined') return;
            for (var r = 0; r < keyboard.length; r++) {
              for (var c = 0; c < keyboard[r].length; c++) {
                  if (keyboard[r][c].toUpperCase().charCodeAt() == event.which) {
                      var row = selectedTab.rows()[r];
                      var key = row.cols()[c].keys()[0];
                      exec(key.executor() + ' ' + key.script(), function(e, stdout, stderr) {
                        if (stderr) { alert(stderr); }
                        vm.commandOutput(stdout);
                      });
                      break;
                  }
              }
          }
      }
  });
  // command output
  vm.commandOutput = ko.observable();
  // auto save
  ko.computed(function() {
    return ko.mapping.toJSON(vm.config);
  }).subscribe(function(configJson) {
    fs.writeFile(CONFIG_FILE_NAME, configJson, function(err) {});
  });
} // HostsViewModel

var config;
if (fs.existsSync(CONFIG_FILE_NAME)) {
    var configJson = fs.readFileSync(CONFIG_FILE_NAME);
    fs.writeFile(CONFIG_FILE_NAME + '.bak', configJson, function(err) {}); // save backup file
    config = JSON.parse(configJson);
} else {
  config = {"defaultExecutor":"autohotkey.exe","defaultScriptEditor":"sublime","looseKeys":[],"tabs":[{"tabName":"Windows","rows":[{"cols":[{"key":"q","keys":[{"keyName":"mak msg box","icon":"","executor":"autohotkey.exe","script":"scripts/win-ahk/makemsgbox.ahk"}]},{"key":"w","keys":[]},{"key":"e","keys":[]},{"key":"r","keys":[]},{"key":"t","keys":[]},{"key":"y","keys":[]}]},{"cols":[{"key":"a","keys":[]},{"key":"s","keys":[]},{"key":"d","keys":[]},{"key":"f","keys":[]},{"key":"g","keys":[]},{"key":"h","keys":[]}]},{"cols":[{"key":"z","keys":[]},{"key":"x","keys":[]},{"key":"c","keys":[]},{"key":"v","keys":[]},{"key":"b","keys":[]},{"key":"n","keys":[]}]}]},{"tabName":"Mac","rows":[{"cols":[{"keys":[{"keyName":"New Chrome Tab","icon":"","executor":"osascript","script":"scripts/mac/newtab.ascript"}],"key":"q"},{"keys":[{"keyName":"Finder Home","icon":"","executor":"open ~","script":""}],"key":"w"},{"key":"e","keys":[]},{"key":"r","keys":[]},{"key":"t","keys":[]},{"key":"y","keys":[]}]},{"cols":[{"key":"a","keys":[]},{"key":"s","keys":[{"keyName":"Icron","icon":"pic.png","executor":"open pic.png","script":""}]},{"key":"d","keys":[]},{"key":"f","keys":[]},{"key":"g","keys":[]},{"key":"h","keys":[]}]},{"cols":[{"key":"z","keys":[]},{"key":"x","keys":[]},{"key":"c","keys":[]},{"key":"v","keys":[]},{"key":"b","keys":[]},{"key":"n","keys":[]}]}]},{"tabName":"Linux","rows":[{"cols":[{"key":"q","keys":[]},{"key":"w","keys":[]},{"key":"e","keys":[]},{"key":"r","keys":[]},{"key":"t","keys":[]},{"key":"y","keys":[]}]},{"cols":[{"key":"a","keys":[]},{"key":"s","keys":[]},{"key":"d","keys":[]},{"key":"f","keys":[]},{"key":"g","keys":[]},{"key":"h","keys":[]}]},{"cols":[{"key":"z","keys":[]},{"key":"x","keys":[]},{"key":"c","keys":[]},{"key":"v","keys":[]},{"key":"b","keys":[]},{"key":"n","keys":[]}]}]}]};
    // config = {
    //     // defaultExecutor : 'AutoHotKey.exe',
    //     defaultExecutor : 'osascript',
    //     defaultScriptEditor : 'sublime',
    //     looseKeys : [],
    //     tabs : [ 
    //         {
    //             tabName : 'chrome',
    //             rows : [
    //                 {cols : [
    //                     {keys : [{
    //                         keyName : 'New Tab',
    //                         icon : '',
    //                         executor : 'osascript',
    //                         script : 'newtab.ascript'
    //                     }]},
    //                     {keys : [{
    //                         keyName : 'New Window',
    //                         icon : '',
    //                         executor : 'osascript',
    //                         script : 'newwindow.ascript'
    //                     }]}, // key
    //                 ]},// bottom row
    //             ] // rows
    //         }, // tab
    //         {
    //             tabName : 'finale',
    //             rows : []

    //         }
    //     ] // tabs
    // };
    for (var t = 0; t < config.tabs.length; t++) {
        fillInMissingKeysOnTab(config.tabs[t]);
    }
}
var vm = new HostsViewModel(config);
ko.bindingHandlers.sortable.beforeMove = vm.verifyMove;
ko.applyBindings(vm);




// var ipc = require('ipc');
            // var updateOnlineStatus = function() {
            //   ipc.send('online-status-changed', navigator.onLine ? 'online' : 'offline');
            // };
var remote = require('remote');
var Menu = remote.require('menu');
var template = [
  {
    label: 'Electron',
    submenu: [
      {
        label: 'About Electron',
        selector: 'orderFrontStandardAboutPanel:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Services',
        submenu: []
      },
      {
        type: 'separator'
      },
      {
        label: 'Hide Electron',
        accelerator: 'Command+H',
        selector: 'hide:'
      },
      {
        label: 'Hide Others',
        accelerator: 'Command+Shift+H',
        selector: 'hideOtherApplications:'
      },
      {
        label: 'Show All',
        selector: 'unhideAllApplications:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Quit',
        accelerator: 'Command+Q',
        selector: 'terminate:'
      },
    ]
  },
  {
    label: 'Edit',
    submenu: [
      {
        label: 'Undo',
        accelerator: 'Command+Z',
        selector: 'undo:'
      },
      {
        label: 'Redo',
        accelerator: 'Shift+Command+Z',
        selector: 'redo:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Cut',
        accelerator: 'Command+X',
        selector: 'cut:'
      },
      {
        label: 'Copy',
        accelerator: 'Command+C',
        selector: 'copy:'
      },
      {
        label: 'Paste',
        accelerator: 'Command+V',
        selector: 'paste:'
      },
      {
        label: 'Select All',
        accelerator: 'Command+A',
        selector: 'selectAll:'
      }
    ]
  },
  {
    label: 'View',
    submenu: [
      {
        label: 'Reload',
        accelerator: 'Command+R',
        click: function() { remote.getCurrentWindow().reload(); }
      },
      {
        label: 'Toggle DevTools',
        accelerator: 'Alt+Command+J',
        click: function() { remote.getCurrentWindow().toggleDevTools(); }
      },
    ]
  },
  {
    label: 'Window',
    submenu: [
      {
        label: 'Minimize',
        accelerator: 'Command+M',
        selector: 'performMiniaturize:'
      },
      {
        label: 'Close',
        accelerator: 'Command+W',
        selector: 'performClose:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Bring All to Front',
        selector: 'arrangeInFront:'
      }
    ]
  },
  {
    label: 'Help',
    submenu: []
  }
];

menu = Menu.buildFromTemplate(template);

Menu.setApplicationMenu(menu);
</script>

    </body>
</html>
