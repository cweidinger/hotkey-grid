<!DOCTYPE html>
<html>
    <head>
        <title>Hotkey Grid</title>
        <script>
        window.cl = console.log.bind(console);
        $ = window.$ = window.jQuery = require('jquery');
        require('jquery-ui');
        require('bootstrap');
        var ko = require('knockout');
        require('knockout-mapping');
        require('knockout-sortable');
        // var keys = require('clays-keys');

        // file system node stuff
        var sys = require('sys');
        function puts(error, stdout, stderr) { sys.puts(stdout) }
        var exec = require('child_process').exec;
        var fs = require('fs');

                 
                 /* <script src="./bower_components/bootstrap/dist/js/bootstrap.js"*/
                 // https://github.com/One-com/knockout-dragdrop
                 // original https://github.com/SteveSanderson/knockout.mapping
                   // https://github.com/derekpeterson/knockout.mapping/network
                   // https://github.com/crissdev/knockout.mapping
                 // http://www.knockmeout.net/2012/02/revisiting-dragging-dropping-and.html
                 //https://github.com/rniemeyer/knockout-sortable

                 // http://stackoverflow.com/questions/16501207/keep-track-of-tabs-with-knockoutjs-twitter-bootstrap
                 // http://jsfiddle.net/rniemeyer/wbtvM/
                 //http://jsfiddle.net/rniemeyer/cGMTV/
        </script>
         <link rel="stylesheet" href="./node_modules/bootstrap/dist/css/bootstrap.css">
         <link rel="stylesheet" href="./node_modules/jquery-ui/themes/smoothness/jquery-ui.css">
    </head>
    <body class='container'>
    <style>
    .btn-key {
        margin-top: 5px;
        margin-bottom: 5px;
        width:95px;
        height: 55px;
    }
    .keySpace {
        border: black 1px dashed;
        margin: 0;
        float: left;
        padding: 0;
        width: 100px;
        height:60px;
    }
    .looseKeyBox {
        list-style-type: none;
        padding: 5px;
        border: black 1px solid;
        z-index:0;
        height:200px;
    }
    #numberedTabs.nav-tabs .active a {
        background-color:#337ab7;
        color:#fff;
    }
    button.command {
        width: 100%;
    }
    </style>
<div role="tabpanel">
    <ul class="nav nav-tabs" id='numberedTabs' role="tablist" data-bind="sortable: config.tabs">
        <li role="presentation" data-bind="css: { active: $root.selectedTab() === $data }">
            <a href="#" role="tab" data-toggle="tab" 
            data-bind="text: text() + ' (' + ($index() + 1) + ')',
                       attr: { href: '#' + text() },
                       click: $root.selectedTab
                       "></a>
        </li>
    </ul>

    <!-- Tab panes -->
    <div class="tab-content" data-bind="sortable: config.tabs">
        <div role="tabpanel" class="tab-pane" data-bind="attr: {id: text}, css: { active: $root.selectedTab() === $data }">
            <div data-bind="foreach: rows">
                <div class="row" data-bind="foreach: cols">
                    <div class="col-xs-2 keySpace" data-bind="sortable: { data: keys, allowDrop : $root.isFull }">
                        <div class="btn btn-primary btn-key"
                            data-bind="html: $data.text() + '<br>' + $parent.key(),
                            click: $root.selectKey,
                            css : typeof $root.selectedKey() === 'undefined' || $root.selectedKey().text() !== $data.text() ? 'btn-primary' : 'btn-danger'">
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

<br>
<div class="row">
    <div class="col-xs-2">
        <button class="btn btn-success command" id='save'>Save</button>
    </div>
    <div class="col-xs-5">
        <div data-bind="with: selectedKey">
          <div class="row">
              <div class="col-xs-3">Key Name</div><div class="col-xs-9"><input id='textInput' data-bind="value:text, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Icon</div><div class="col-xs-9"><input data-bind="value:icon, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Executor</div><div class="col-xs-9"><input data-bind="value:executor, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <div class="col-xs-3">Script</div>
              <div class="col-xs-9"><input data-bind="value:script, valueUpdate:'afterkeydown'"/></div>
          </div>
          <div class="row">
              <button class="btn btn-success col-xs-6" id='clear'>Done</button>
              <button class="btn btn-danger col-xs-6" id='delete'>Delete</button>
          </div>
        </div>
    </div>
    <div class="col-xs-5">
        <div class="looseKeyBox" data-bind="sortable: config.looseKeys">
            <div class="btn btn-primary btn-key" 
            data-bind=" html: text,
                        click: $root.selectKey,
                        css : typeof $root.selectedKey() === 'undefined' || $root.selectedKey().text() !== $data.text() ? 'btn-primary' : 'btn-danger'"></div>
        </div>
        <div class="row">
            <div class="col-xs-6">
                <h4>Loose Keys</h4>
            </div>
            <div class="col-xs-6">
                <button class="btn btn-primary command" id='add'>Add</button>
            </div>
        </div>
    </div>
</div>
<div class="row">
    <div class="col-xs-2">
        <button class="btn btn-success command" data-bind="click : $root.addTab">Add Tab</button>
    </div>
    <div class="col-xs-5">
        <div data-bind="with: selectedTab">
          <div class="row">
              <div class="col-xs-3">Tab Name</div>
              <div class="col-xs-6">
                <input id='tabText' data-bind="value:text, valueUpdate:'afterkeydown'"/>
              </div>
              <button class="btn btn-danger col-xs-3" data-bind="click : $root.deleteTab">Delete</button>
          </div>
        </div>
    </div>
</div>
<script>
// active class on li and div see - http://getbootstrap.com/javascript/#tabs

var keyboard = [
    ['q', 'w', 'e', 'r', 't', 'y'],
    ['a', 's', 'd', 'f', 'g', 'h'],
    ['z', 'x', 'c', 'v', 'b', 'n']
];
var MAX_TABS = 6;

function fillInMissingKeysOnTab(tab) {
    for (var r = 0; r < 3; r++) {
        if (typeof tab.rows[r] === 'undefined') {
            tab.rows[r] = {cols:[]};
        }
        var row = tab.rows[r];
        for (var k = 0; k < 6; k++) {
            if (typeof row.cols[k] === 'undefined') {
                row.cols[k] = {key: keyboard[r][k], keys:[]};
            } else {
                row.cols[k].key = keyboard[r][k];
            }
        }
    }
    return tab;
}

function HostsViewModel(config) {
    var vm = this;
    this.config = ko.mapping.fromJS(config);
    // tab stuff
    this.selectedTab = ko.observable();
    this.selectedTab(this.config.tabs()[0]);
    //vm.config.tabs()[tabindex]
    this.clearTab = function() {
        vm.selectedTab(undefined);
    };
    this.addTab = function() {
        if (vm.config.tabs().length === MAX_TABS) return;
        var tab = ko.mapping.fromJS(fillInMissingKeysOnTab({ text : 'New Tab', rows : [] }));
        vm.config.tabs.push(tab);
        vm.selectedTab(tab);
        setTimeout(function() {   $('#tabText').focus().select();   });
    };
    this.deleteTab = function() {
        var selectedTab = vm.selectedTab();
        var tabs = vm.config.tabs();
        if (tabs.length === 1) { alert('You cannot delete your only tab.'); return }
        for (var t = 0; t < tabs.length; t++) {
            if (tabs[t] == selectedTab) {
                vm.config.tabs.splice(t,1);
                if (t === 0) {
                    vm.selectedTab(tabs[0]);
                } else {
                    vm.selectedTab(tabs[t-1]);
                }
                return;
            }
        }
    };
    this.moveRight = function() {
        var selectedTab = vm.selectedTab();
        var tabs = vm.config.tabs();
        if (tabs.length === 1) { alert('You cannot delete your only tab.'); return }
        for (var t = 0; t < tabs.length; t++) {
            if (tabs[t] == selectedTab) {
                vm.config.tabs.splice(t,1);
                if (t === 0) {
                    vm.selectedTab(tabs[0]);
                } else {
                    vm.selectedTab(tabs[t-1]);
                }
                return;
            }
        }
    };
    // key stuff
    this.isFull = function(parent) {
        return parent().length < 1;
    };
    this.selectedKey = ko.observable();
    this.verifyMove = function(arg, event, ui ) {
        if ($(ui.sender).attr('id') === 'numberedTabs' && $(event.target).attr('id') !== 'numberedTabs') { arg.cancelDrop = true; return }
        // prevent person from moving off this tab directly by going to the top right corner
        var targetId = $(event.target).parents().filter('.tab-pane').attr('id');
        var senderId = $(ui.sender).parents().filter('.tab-pane').attr('id');
        if (typeof targetId === 'string' && typeof senderId === 'string' && targetId != senderId) arg.cancelDrop = true;
    };
    $(document).on('click', '#clear', function() {
        vm.selectedKey(undefined);
    });
    $(document).on('click', '#delete', function() {
        var key = vm.selectedKey();
        var tabs = vm.config.tabs();
        for (var t = 0; t < tabs.length; t++) {
            var rows = tabs[t].rows();
            for (var r = 0; r < 3; r++) {
                var cols = rows[r].cols();
                for (var k = 0; k < 6; k++) {
                    if (cols[k].keys()[0] === key) {
                        cols[k].keys.pop();
                        break;
                    }
                }
            }

        }
        vm.selectedKey(undefined);
    });
    $('#add').click(function() {
        var key = ko.mapping.fromJS({
            text : 'New Key',
            icon : '',
            executor : vm.config.defaultExecutor,
            script : ''
        });
        vm.config.looseKeys.push(key);
        vm.selectedKey(key);
        setTimeout(function() {
            $('#textInput').focus().select();
        });
    });
    this.selectKey = function(p) { vm.selectedKey(p); };

    // save
    $('#save').click(function() {
        var configJson = ko.mapping.toJSON(vm.config);
        fs.writeFile("./config.hkg", configJson, function(err) {});
    });

    // make keys work
    $(document).on('keydown', function() {
        if (document.activeElement.tagName === 'INPUT') return true;
        var keyStr = String.fromCharCode(event.which);
        if (!isNaN(keyStr)) {
            var index = parseInt(keyStr, 10) - 1;
            var tabs = vm.config.tabs();
            if (index === -1) {
                vm.selectedTab(vm.config.tabs()[0]);
            } else if (tabs.length > index) {
                vm.selectedTab(vm.config.tabs()[index]);
            } else if (tabs.length < MAX_TABS) {
                vm.addTab();
            }
        } else {
            var selectedTab = vm.selectedTab();
            if (typeof selectedTab === 'undefined') return;
            for (var r = 0; r < keyboard.length; r++) {
                for (var c = 0; c < keyboard[r].length; c++) {
                    if (keyboard[r][c].toUpperCase().charCodeAt() == event.which) {

                        var row = selectedTab.rows()[r];
                        var key = row.cols()[c].keys()[0];
                        exec(key.executor() + ' ' + key.script(), puts);

                        break;
                    }
                }
            }
        }
      // if (event.which) {
      //   mainWindow.reload();
      // }
    });
} // HostsViewModel

var config;
if (fs.existsSync('./config.hkg')) {
    var configJson = fs.readFileSync('./config.hkg');
    config = JSON.parse(configJson);
} else {
    config = {
        // defaultExecutor : 'AutoHotKey.exe',
        defaultExecutor : 'osascript',
        looseKeys : [],
        tabs : [ 
            {
                text : 'chrome',
                rows : [
                    {cols : [
                        {keys : [{
                            text : 'New Tab',
                            icon : '',
                            executor : 'osascript',
                            script : 'newtab.ascript'
                        }]},
                        {keys : [{
                            text : 'New Window',
                            icon : '',
                            executor : 'osascript',
                            script : 'newwindow.ascript'
                        }]}, // key
                    ]},// bottom row
                ] // rows
            }, // tab
            {
                text : 'finale',
                rows : []

            }
        ] // tabs
    };
    for (var t = 0; t < config.tabs.length; t++) {
        fillInMissingKeysOnTab(config.tabs[t]);
    }
}
var vm = new HostsViewModel(config);
ko.bindingHandlers.sortable.beforeMove = vm.verifyMove;
ko.applyBindings(vm);

// $(function() {

//     $('.nav-tabs a').click(function (e) {
//         e.preventDefault();
//         $(this).tab('show');
//     });
//     $('.nav-tabs a').first().tab('show');


// });



// var ipc = require('ipc');
            // var updateOnlineStatus = function() {
            //   ipc.send('online-status-changed', navigator.onLine ? 'online' : 'offline');
            // };
var remote = require('remote');
var Menu = remote.require('menu');
var template = [
  {
    label: 'Electron',
    submenu: [
      {
        label: 'About Electron',
        selector: 'orderFrontStandardAboutPanel:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Services',
        submenu: []
      },
      {
        type: 'separator'
      },
      {
        label: 'Hide Electron',
        accelerator: 'Command+H',
        selector: 'hide:'
      },
      {
        label: 'Hide Others',
        accelerator: 'Command+Shift+H',
        selector: 'hideOtherApplications:'
      },
      {
        label: 'Show All',
        selector: 'unhideAllApplications:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Quit',
        accelerator: 'Command+Q',
        selector: 'terminate:'
      },
    ]
  },
  {
    label: 'Edit',
    submenu: [
      {
        label: 'Undo',
        accelerator: 'Command+Z',
        selector: 'undo:'
      },
      {
        label: 'Redo',
        accelerator: 'Shift+Command+Z',
        selector: 'redo:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Cut',
        accelerator: 'Command+X',
        selector: 'cut:'
      },
      {
        label: 'Copy',
        accelerator: 'Command+C',
        selector: 'copy:'
      },
      {
        label: 'Paste',
        accelerator: 'Command+V',
        selector: 'paste:'
      },
      {
        label: 'Select All',
        accelerator: 'Command+A',
        selector: 'selectAll:'
      }
    ]
  },
  {
    label: 'View',
    submenu: [
      {
        label: 'Reload',
        accelerator: 'Command+R',
        click: function() { remote.getCurrentWindow().reload(); }
      },
      {
        label: 'Toggle DevTools',
        accelerator: 'Alt+Command+J',
        click: function() { remote.getCurrentWindow().toggleDevTools(); }
      },
    ]
  },
  {
    label: 'Window',
    submenu: [
      {
        label: 'Minimize',
        accelerator: 'Command+M',
        selector: 'performMiniaturize:'
      },
      {
        label: 'Close',
        accelerator: 'Command+W',
        selector: 'performClose:'
      },
      {
        type: 'separator'
      },
      {
        label: 'Bring All to Front',
        selector: 'arrangeInFront:'
      }
    ]
  },
  {
    label: 'Help',
    submenu: []
  }
];

menu = Menu.buildFromTemplate(template);

Menu.setApplicationMenu(menu);
</script>

    </body>
</html>
